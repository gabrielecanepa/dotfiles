#!/bin/zsh

YLW="\e[33m"
GRN="\e[32m"
RED="\e[31m"
NC="\e[0m"
CUT="\r\033[1A\033[0K"

case $1 in
  (-h|--help)
    echo "Usage: node_modules <command>"
    echo
    echo "Commands:"
    echo -e "  list\t	List all the modules installed in your working directory"
    echo -e "  clear\t	Remove all the modules installed in your working directory"
    ;;

  (list)
    echo "Looking for modules in your working directory..."
    node_modules=$(find $WORKING_DIR -name "node_modules" -type d -prune -print | xargs du -chs | sort -hr)
    if [ $node_modules ]; then
      echo "${CUT}$node_modules"
    else
      echo "${CUT}${RED}Can't find any module in your working directory${NC}"
    fi
    ;;

  (clear)
    echo "Looking for modules in your working directory..."
    projects_count=$(find $WORKING_DIR -name "node_modules" -type d -prune | grep -c /)
    if [ $projects_count -gt 0 ]; then
      echo "${CUT}${YLW}WARNING: this will remove the node_modules folder from $projects_count project$([ $projects_count -gt 0 ] && echo s)${NC}"
      printf "Are you sure you want to continue? (y/n [n]) "
      read choice
      if [[ $choice =~ [yY] ]]; then
        echo "Removing modules from your working directory..."
        find $WORKING_DIR -name "node_modules" -type d -prune -exec rm -rf '{}' +
        echo "${CUT}${GRN}Modules successfully removed from your working directory${NC}"
      fi
    else
      echo "${CUT}${RED}Can't find any module in your working directory${NC}"
    fi
    ;;

  (*)
    node_modules --help
    ;;
esac
